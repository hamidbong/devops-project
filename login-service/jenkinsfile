pipeline {

    agent any

    environment {
        SONAR_TOKEN = credentials('sonarqube')
        SONARQUBE = 'sonarqube_devops_master_analyse'
        IMAGE_NAME = "hamidbong/login-service"
        TRIVY_SERVER = "http://192.168.1.178:4954"
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install dependencies') {
            steps {
                dir('login-service') {
                    sh 'npm install'
                }
            }
        }

        stage('Run Tests') {
            steps {
                dir('login-service') {
                    sh 'npm test || true'
                }
            }
        }

        /*stage('Sonar Analysis') {
            environment {
                SONAR_TOKEN = credentials('sonarqube')
            }
            steps {
                withSonarQubeEnv("${SONARQUBE}") {
                    sh "sonar-scanner -Dsonar.projectKey=ci-cd-node-demo -Dsonar.sources=. -Dsonar.login=${SONAR_TOKEN}"
                }
            }
        }*/


        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv("${SONARQUBE}") {
                    dir('login-service') {
                        sh '''
                            sonar-scanner \
                              -Dsonar.projectKey=ci-cd-node-demo \
                              -Dsonar.sources=. \
                              -Dsonar.host.url=http://192.168.1.178:9000 \
                              -Dsonar.login=${SONAR_TOKEN}
                        '''
                    }
                }
            }
        }

        stage('Quality Gates') {
            steps {
                retry(3) {
                    timeout(time: 1, unit: 'MINUTES') {
                        waitForQualityGate abortPipeline: true
                    }
                }
            }
        }

        stage('Docker Access Test') {
            steps {
                sh 'docker version'
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('login-service') {
                    script {
                        docker.build("${IMAGE_NAME}:${env.BUILD_ID}")
                    }
                }
            }
        }

        stage('Setup Caches') {
            steps {
                sh 'docker volume create --name trivy_cache || true'
                sh 'docker volume create --name trivy_javadb_cache || true'
            }
        }

        stage('Scan with Trivy') {
            steps {
                sh """
                    docker run --rm \
                        -v /var/run/docker.sock:/var/run/docker.sock \
                        -v trivy_cache:/root/.cache/trivy \
                        -v trivy_javadb_cache:/root/.cache/trivy-java-db \
                        -e TRIVY_TIMEOUT=30m \
                        aquasec/trivy:latest \
                        image \
                        --exit-code 1 \
                        --severity CRITICAL,HIGH \
                        --ignore-unfixed \
                        --timeout 30m \
                        ${IMAGE_NAME}:${env.BUILD_ID}
                """
            }
        }

        stage('Build and Push Docker Image') {
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/', 'dockerHub-login') {
                        def image = docker.build("${IMAGE_NAME}:${env.BUILD_ID}", "./login-service")
                        image.push()
                        image.push('latest')
                    }
                }
            }
        }

    }
}
