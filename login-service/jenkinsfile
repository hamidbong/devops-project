pipeline {

    agent any

    tools {
        nodejs 'NodeJS_20'
    }


    environment {
        SONAR_TOKEN = credentials('sonarqube_token-login')
        SONARQUBE = 'sonarqube_devops_master_analyse'
        IMAGE_NAME = "hamidbong/login-service"
        TRIVY_SERVER = "http://192.168.1.20:4954"
    }
    

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Verify Node.js') {
            steps {
                sh '''
                node --version
                npm --version
                which node
                '''
            }
        }

        stage('Install dependencies') {
            steps {
                dir('login-service') {
                    sh 'npm install'
                }
            }
        }

        stage('Run Tests') {
            steps {
                dir('login-service') {
                    sh 'npm test || true'
                }
            }
        }

        
        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('sonarqube_devops_master_analyse') {
                    script {
                        def nodePath = sh(returnStdout: true, script: 'which node').trim()
                        
                        sh """
                        ${tool('SonarScanner')}/bin/sonar-scanner \
                          -Dsonar.projectKey=ci-cd-npm-node \
                          -Dsonar.projectName=login-service \
                          -Dsonar.projectVersion=${env.BUILD_NUMBER} \
                          -Dsonar.sources=. \
                          -Dsonar.host.url=${SONAR_HOST_URL} \
                          -Dsonar.login=${SONAR_TOKEN} \
                          -Dsonar.nodejs.executable=${nodePath} \
                          -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \
                          -Dsonar.exclusions=**/node_modules/**
                        """
                    }
                }
            }
        }
        /*stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv("${SONARQUBE}") {
                    tool name: 'SonarScanner', type: 'hudson.plugins.sonar.SonarRunnerInstallation'
                    sh 'SonarScanner -Dsonar.projectKey=ci-cd-npm-node -Dsonar.projectName=login-service -Dsonar.sources=. -Dsonar.login=$SONAR_TOKEN'
                }
            }
        }


        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv("${SonarScanner}") {
                    sh '''
                    sonar-scanner \
                    -Dsonar.projectKey=ci-cd-npm-node \
                    -Dsonar.projectName=login-service \
                    -Dsonar.sources=. \
                    -Dsonar.host.url=http://192.168.100.151:9000 \
                    -Dsonar.login=${SONAR_TOKEN} \
                    -Dsonar.nodejs.executable=$(which node) \
                    -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \
                    '''
                }
            }
        }
        
        /*stage('Sonar Analysis') {
           
            steps {
                withSonarQubeEnv("${SONARQUBE}") {
                    sh 'sonar-scanner -Dsonar.projectKey=ci-cd-demo -Dsonar.sources=. -Dsonar.login=${SONAR_TOKEN}'
                }
            }
        }*/


        /*stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv("${SONARQUBE}") {
                    dir('login-service') {
                        sh '''
                            sonar-scanner \
                              -Dsonar.projectKey=ci-cd-node-demo \
                              -Dsonar.sources=. \
                              -Dsonar.host.url=http://192.168.1.20:9000 \
                              -Dsonar.login=${SONAR_TOKEN}
                        '''
                    }
                }
            }
        }*/

        stage('Quality Gates') {
            steps {
                retry(3) {
                    timeout(time: 1, unit: 'MINUTES') {
                        waitForQualityGate abortPipeline: true
                    }
                }
            }
        }

        stage('Docker Access Test') {
            steps {
                sh 'docker version'
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('login-service') {
                    script {
                        docker.build("${IMAGE_NAME}:${env.BUILD_ID}")
                    }
                }
            }
        }

        stage('Setup Caches') {
            steps {
                sh 'docker volume create --name trivy_cache || true'
                sh 'docker volume create --name trivy_javadb_cache || true'
            }
        }

        stage('Scan with Trivy') {
            steps {
                sh """
                    docker run --rm \
                        -v /var/run/docker.sock:/var/run/docker.sock \
                        -v trivy_cache:/root/.cache/trivy \
                        -v trivy_javadb_cache:/root/.cache/trivy-java-db \
                        -e TRIVY_TIMEOUT=30m \
                        aquasec/trivy:latest \
                        image \
                        --exit-code 1 \
                        --severity CRITICAL,HIGH \
                        --ignore-unfixed \
                        --timeout 30m \
                        ${IMAGE_NAME}:${env.BUILD_ID}
                """
            }
        }

        stage('Build and Push Docker Image') {
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/', 'dockerHub-login') {
                        def image = docker.build("${IMAGE_NAME}:${env.BUILD_ID}", "./login-service")
                        image.push()
                        image.push('latest')
                    }
                }
            }
        }

    }
}
