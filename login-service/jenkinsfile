pipeline {

    agent any

   


    environment {
        SONAR_TOKEN = credentials('sonarqube_token-login')
        SONARQUBE = 'sonarqube_devops_master_analyse'
        NVD_API_KEY = credentials('nvd-api-key')
        IMAGE_NAME = "hamidbong/login-service"
        TRIVY_SERVER = "http://192.168.100.151:4954"
    }
    

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Verify Node.js') {
            steps {
                sh '''
                node --version
                npm --version
                which node
                '''
            }
        }

        stage('Install dependencies') {
            steps {
                dir('login-service') {
                    sh 'npm install'
                }
            }
        }

        stage('Run Tests') {
            steps {
                dir('login-service') {
                    sh 'npm test || true'
                }
            }
        }

        /*stage('OWASP Dependency Check') {
            steps {
                dir('login-service') {
                    sh '''
                    mkdir -p ../dependency-check-report
                    docker run --rm \
                        -v $(pwd):/src \
                        -v $(pwd)/../dependency-check-report:/report \
                        owasp/dependency-check \
                        --project "login-service" \
                        --scan /src \
                        --format "HTML" \
                        --out /report
                    '''
                }
            }
        }*/

        stage('OWASP Dependency Check') {
            steps {
                dir('login-service') {
                    sh '''
                    mkdir -p ../dependency-check-report
                    docker volume create owasp_depcheck_data || true
                    docker run --rm \
                        -v owasp_depcheck_data:/usr/share/dependency-check/data \
                        -v $(pwd):/src \
                        -v $(pwd)/../dependency-check-report:/report \
                        owasp/dependency-check \
                        --project "login-service" \
                        --scan /src \
                        --format "HTML" \
                        --out /report \
                        --nvdApiKey ${NVD_API_KEY}
                    '''
                }
            }
        }



        stage('Archive Dependency Report') {
            steps {
                archiveArtifacts artifacts: 'dependency-check-report/dependency-check-report.html', allowEmptyArchive: true
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('sonarqube_devops_master_analyse') {
                    script {
                        def nodePath = sh(returnStdout: true, script: 'which node').trim()
                        
                        sh """
                        ${tool('SonarScanner')}/bin/sonar-scanner \
                          -Dsonar.projectKey=ci-cd-npm-node \
                          -Dsonar.projectName=login-service \
                          -Dsonar.projectVersion=${env.BUILD_NUMBER} \
                          -Dsonar.sources=. \
                          -Dsonar.host.url=${SONAR_HOST_URL} \
                          -Dsonar.login=$SONAR_TOKEN \
                          -Dsonar.nodejs.executable=${nodePath} \
                          -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
                        """
                    }
                }
            }
        }

        stage('Quality Gates') {
            steps {
                retry(3) {
                    timeout(time: 1, unit: 'MINUTES') {
                        waitForQualityGate abortPipeline: true
                    }
                }
            }
        }

        stage('Docker Access Test') {
            steps {
                sh 'docker version'
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('login-service') {
                    timeout(time: 15, unit: 'MINUTES') {
                        script {
                            dockerImage = docker.build("${IMAGE_NAME}:${env.BUILD_ID}")
                        }
                    }
                }
            }
        }

        

        stage('Setup Caches') {
            steps {
                sh 'docker volume create --name trivy_cache || true'
                sh 'docker volume create --name trivy_javadb_cache || true'
            }
        }
        ////second option
        //  de scan trivy sans option socket docker si l'image est deja pouss√©
        /*stage('Scan with Trivy') {
            steps {
                sh """
                    docker run --rm \
                        -v trivy_cache:/root/.cache/trivy \
                        -v trivy_javadb_cache:/root/.cache/trivy-java-db \
                        aquasec/trivy:latest \
                        image \
                        --exit-code 1 \
                        --severity CRITICAL,HIGH \
                        --ignore-unfixed \
                        --no-progress \
                        --format table \
                        --timeout 30m \
                        ${IMAGE_NAME}:${env.BUILD_ID}
                """
            }
        }*/

        stage('Scan with Trivy') {
            steps {
                sh """
                    docker run --rm \
                        -v /var/run/docker.sock:/var/run/docker.sock \
                        -v trivy_cache:/root/.cache/trivy \
                        -v trivy_javadb_cache:/root/.cache/trivy-java-db \
                        -e TRIVY_TIMEOUT=30m \
                        aquasec/trivy:latest \
                        image \
                        --exit-code 1 \
                        --severity CRITICAL,HIGH \
                        --ignore-unfixed \
                        --timeout 30m \
                        ${IMAGE_NAME}:${env.BUILD_ID}
                """
            }
        }

        stage('Push Docker Image') {
            steps {
                dir('login-service') {
                    script {
                        docker.withRegistry('https://index.docker.io/v1/', 'dockerHub-login') {
                            dockerImage.push()
                            // Optionally push as 'latest'
                            //dockerImage.push('latest')
                        }
                    }
                }
            }
        }

        

        stage('Apply Kubernetes Files') {
            steps {
                withKubeConfig([credentialsId: 'kubeconfig']) {
                    sh """
                    cat k8s/login-service/deployment.yaml | sed "s/{{BUILD_NUMBER}}/${env.BUILD_ID}/g" | kubectl apply -f -
                    """
                    sh 'kubectl apply -f k8s/login-service/service.yaml'
                    //sh 'kubectl apply -f k8s/ingress.yaml'
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                withKubeConfig([credentialsId: 'kubeconfig']) {
                    sh 'kubectl rollout status deployment/login-deployment'
                }
            }
        }

    }
}
